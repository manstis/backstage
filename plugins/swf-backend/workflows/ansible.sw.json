{
  "id": "swf-ansible-job",
  "version": "1.0",
  "specVersion": "0.8",
  "name": "[SWF] Ansible Job",
  "description": "[SWF] Launch an Ansible Job within Ansible Automation Platform",
  "dataInputSchema": "schemas/ansible-workflow-input.json",
  "functions": [
    {
      "name": "runActionTemplateFetch",
      "operation": "specs/actions-openapi.json#fetch:template"
    },
    {
      "name": "runActionGitHubRepoPush",
      "operation": "specs/actions-openapi.json#github:repo:push"
    },
    {
      "name": "runActionCatalogRegister",
      "operation": "specs/actions-openapi.json#catalog:register"
    }
  ],
  "start": "Generating the Ansible Job component",
  "states": [
    {
      "name": "Generating the Ansible Job component",
      "type": "operation",
      "actionMode": "sequential",
      "actions": [
        {
          "name": "Run Template Fetch Action",
          "functionRef": {
            "refName": "runActionTemplateFetch",
            "arguments": {
              "url": "./skeleton",
              "targetPath": "argo/ansibleJobs/",
              "values": {
                "component_id": "${{ .name }}",
                "jobTemplate": "${{ .jobTemplate }}",
                "name": "${{ .name }}",
                "namespace": "${{ .namespace }}",
                "connection_secret": "${{ .connection_secret }}"
              }
            }
          },
          "actionDataFilter": {
            "toStateData": ".actionResult"
          }
        }
      ],
      "transition": "Generating the Catalog Info Component"
    },
    {
      "name": "Generating the Catalog Info Component",
      "type": "operation",
      "actionMode": "sequential",
      "actions": [
        {
          "functionRef": {
            "refName": "runActionTemplateFetch",
            "arguments": {
              "url": "../../scaffolder-skeletons/catalog-info-skeleton/",
              "values": {
                "githubOrg": "${{ .githubOrg }}",
                "repoName": "${{ .repoName }}",
                "owner": "${{ .owner }}",
                "applicationType": "api",
                "description": "${{ .description }}"
              }
            }
          },
          "actionDataFilter": {
            "toStateData": ".actionResult"
          }
        }
      ],
      "transition": "Publish to GitHub"
    },
    {
      "name": "Publish to GitHub",
      "type": "operation",
      "actionMode": "sequential",
      "actions": [
        {
          "functionRef": {
            "refName": "runActionGitHubRepoPush",
            "arguments": {
              "repoUrl": "github.com?owner=${{ parameters.githubOrg }}&repo=${{ parameters.repoName }}",
              "protectDefaultBranch": false,
              "protectEnforceAdmins": false
            }
          },
          "actionDataFilter": {
            "toStateData": ".actionResult"
          }
        }
      ],
      "transition": "Register Catalog entry"
    },
    {
      "name": "Register Catalog entry",
      "type": "operation",
      "actionMode": "sequential",
      "actions": [
        {
          "functionRef": {
            "refName": "runActionCatalogRegister",
            "arguments": {
              "repoContentsUrl": "${{ steps.publish.output.repoContentsUrl }}",
              "catalogInfoPath": "/catalog-info.yaml"
            }
          },
          "actionDataFilter": {
            "toStateData": ".actionResult"
          }
        }
      ],
      "end": true
    }
  ]
}
